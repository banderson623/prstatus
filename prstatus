#!/usr/bin/env bash

## Enter your OAuth token here to avoid having
## to re-enter in the command line every time
token=""


#####################################
### DO NOT EDIT BEYOND THIS POINT ###
#####################################

## FORMATTING
_bold=$(tput bold) 
_reset=$(tput sgr0)


## Argument validation
arg_check()
{
  if [ -z "$token" ]; then
    echo -e "${_bold}ERROR: OAuth token not specified (required)${_reset}\n"
    show_help
    exit
  fi

  if [ -z "$repo" ]; then
    echo -e "${_bold}ERROR: Repository not specified (required)${_reset}\n"
    show_help
    exit
  fi

  if [ -z "$prid" ]; then
    endpoint="repos$target/$repo/pulls"
    pr_display=false # TODO
  else
    endpoint="repos$target/$repo/pulls/$prid"
    pr_display=true # TODO
  fi
}


## USAGE HELP
show_help() 
{
  cat << EOF
Usage: $0 [-dh] [-t TOKEN] [-r REPO]...
Options:
    -h | --help                 display this syntax information and exit
    -d | --debug                display API request details and exit
    -t | --token TOKEN          OAuth token ${_bold}(required)${_reset}
                                  More info: http://git.io/vmNUX
                                  Example:  $0 -t e72e16c7e42f292c6912e7710c8
    -r | --repo USER/REPO       Target repository ${_bold}(required)${_reset}
                                  Note: specify repo\'s owner username OR organization
                                  Example:  $0 -r reddit/reddit
                                            $0 -r levifig/prstatus
    -p | --pullrequest ID       Specify unique pull request by its ID
                                  Example:  $0 -p 1449
EOF
}


## DEBUG
debug() 
{
  # DEBUG: show parsed arguments and exit
  # TODO: show "nil" for empty arguments
  echo " ===== Repo set to: $repo"
  echo " ===== PR set to: $prid"
  echo " ===== API endpoint set to: $endpoint"
  echo " ===== Auth token set to: $token"
  exit
}


## API REQUEST
request() 
{
  arg_check
  curl -s \
    -G "https://api.github.com/$endpoint?$params" \
    -H "Authorization: token $token"
}


gh_response() 
{
  echo $(request) | jq -c '.[] | { id: .number, title: .title }'
}

main() { gh_response; }

## ARGUMENT PARSING
while :; do
  case $1 in
    -r | --repo )
      repo="$2"
      shift
      ;;
    -p | --pullrequest )
      prid="$2"
      shift
      ;;
    -t | --token )
      token="$2"
      shift
      ;;
    -d | --debug )
      debug
      shift
      ;;
    -h |--help | -\? )
      show_help
      exit
      ;;
    * )
      # No more arguments to parse
      main
      break
  esac
  shift
done


## ===== TODO ======
## - Implement output format (e.g. json, csv, etc)
##   for cleaner integration with other scripts
##
## -
